version: "3.8"

services:
  # Redpanda - Kafka-compatible streaming platform
  redpanda:
    image: redpandadata/redpanda:latest
    container_name: scootermap-redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --node-id 0
      - --check=false
      - --kafka-addr internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"  # Kafka API (external)
      - "9644:9644"    # Admin API
      - "8082:8082"    # HTTP Proxy
    volumes:
      - redpanda-data:/var/lib/redpanda/data
    networks:
      - scootermap-network
    healthcheck:
      test: ["CMD", "rpk", "cluster", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redpanda Console - Web UI for Redpanda
  console:
    image: redpandadata/console:latest
    container_name: scootermap-console
    depends_on:
      - redpanda
    ports:
      - "8080:8080"
    environment:
      KAFKA_BROKERS: redpanda:9092
    networks:
      - scootermap-network

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: scootermap-backend
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - DUCKDB_PATH=/app/data/mobility.duckdb
      - API_HOST=0.0.0.0
      - API_PORT=8000
    volumes:
      - ./data:/app/data
    networks:
      - scootermap-network
    restart: unless-stopped

  # GBFS Producer - Fetches scooter data
  producer:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: scootermap-producer
    command: ["python", "run_producer.py"]
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - DUCKDB_PATH=/app/data/mobility.duckdb
    volumes:
      - ./data:/app/data
    networks:
      - scootermap-network
    restart: unless-stopped

  # GBFS Consumer - Processes and aggregates data
  consumer:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: scootermap-consumer
    command: ["python", "run_consumer.py"]
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
      - DUCKDB_PATH=/app/data/mobility.duckdb
    volumes:
      - ./data:/app/data
    networks:
      - scootermap-network
    restart: unless-stopped

  # Frontend - React application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: scootermap-frontend
    depends_on:
      - backend
    ports:
      - "3000:80"
    networks:
      - scootermap-network
    restart: unless-stopped

volumes:
  redpanda-data:

networks:
  scootermap-network:
    driver: bridge

